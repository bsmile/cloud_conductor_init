#!/bin/sh
# Copyright 2014 TIS Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

CONDUCTOR_ROOT_DIR="/opt/cloudconductor"
CONDUCTOR_PATTERNS_ROOT_DIR="${CONDUCTOR_ROOT_DIR}/patterns"
CONDUCTOR_EVENT_HANDLER_DIR="<%= @event_handlers_directory %>"
CONFIG_FILE="/etc/profile.d/chef.sh"
TMP_DIR="${CONDUCTOR_ROOT_DIR}/tmp"
LOG_DIR="${TMP_DIR}/logs"
LOG_FILE="${LOG_DIR}/event-handler.log"

mkdir -p ${LOG_DIR}

function log() {
  message="$1"
  echo "[`date +'%Y/%m/%d %H:%M:%S'`] $1" >> ${LOG_FILE}
}

if [ -f ${CONFIG_FILE} ]; then
  chefdk_path="`cat ${CONFIG_FILE} | awk -F: '{print $2}'`"
  export PATH=${chefdk_path}:${PATH}
else
  log "finished abnormally. ${CONFIG_FILE} couldn't be loaded."
  exit -1
fi

ruby_log="`ruby ${CONDUCTOR_EVENT_HANDLER_DIR}/action_runner.rb 2>&1`"
ruby_result=$?
log "${ruby_log}"
if [ ${ruby_result} -ne 0 ]; then
  log "finished abnormally. action_runner has failed to run."
  exit -1
fi

log "finished successfully."
